# GitHub Actions CI Configuration
# Financial-Grade Workflow Engine
# Zero Tolerance for Silent Failures

name: Financial-Grade CI

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx768m'

jobs:

  # ============================================================================
  # JOB 1: Java Version Enforcement
  # ============================================================================
  enforce-java-version:
    name: ✅ Enforce Java 17
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify Java Version
        run: |
          java -version
          javac -version
          if [[ $(java -version 2>&1 | grep "version" | awk '{print $3}' | tr -d '"' | cut -d'.' -f1) -ne 17 ]]; then
            echo "❌ CRITICAL: Java 17 required!"
            exit 1
          fi
          echo "✅ Java 17 verified"

  # ============================================================================
  # JOB 2: Code Formatting Check
  # ============================================================================
  code-formatting:
    name: ✅ Code Formatting (Spotless)
    runs-on: ubuntu-latest
    needs: enforce-java-version
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check Code Formatting
        run: |
          mvn spotless:check
          if [ $? -ne 0 ]; then
            echo "❌ Code formatting violations detected!"
            echo "Run: mvn spotless:apply"
            exit 1
          fi
          echo "✅ Code formatting passed"

  # ============================================================================
  # JOB 3: Compilation
  # ============================================================================
  compile:
    name: ✅ Compilation
    runs-on: ubuntu-latest
    needs: enforce-java-version
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile
        run: |
          mvn clean compile -DskipTests
          if [ $? -ne 0 ]; then
            echo "❌ Compilation failed!"
            exit 1
          fi
          echo "✅ Compilation successful"

  # ============================================================================
  # JOB 4: Unit Tests
  # ============================================================================
  unit-tests:
    name: ✅ Unit Tests (100% Pass Required)
    runs-on: ubuntu-latest
    needs: [compile, code-formatting]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Unit Tests
        run: |
          mvn test -Dtest="*Test" -DfailIfNoTests=false

      - name: Check Test Results
        run: |
          FAILURES=$(grep -r "failures=\"" target/surefire-reports/*.xml | grep -v "failures=\"0\"" | wc -l)
          ERRORS=$(grep -r "errors=\"" target/surefire-reports/*.xml | grep -v "errors=\"0\"" | wc -l)
          SKIPPED=$(grep -r "skipped=\"" target/surefire-reports/*.xml | grep -v "skipped=\"0\"" | wc -l)
          
          if [ $FAILURES -gt 0 ] || [ $ERRORS -gt 0 ]; then
            echo "❌ CRITICAL: Test failures or errors detected!"
            echo "Failures: $FAILURES"
            echo "Errors: $ERRORS"
            exit 1
          fi
          
          if [ $SKIPPED -gt 0 ]; then
            echo "⚠️ WARNING: Skipped tests detected (allowed if @Disabled with documentation)"
            echo "Skipped: $SKIPPED"
          fi
          
          echo "✅ All unit tests passed!"

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: target/surefire-reports/

  # ============================================================================
  # JOB 5: Integration Tests
  # ============================================================================
  integration-tests:
    name: ✅ Integration Tests (100% Pass Required)
    runs-on: ubuntu-latest
    needs: [compile, code-formatting]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Integration Tests
        run: |
          mvn test -Dtest="*IntegrationTest" -DfailIfNoTests=false

      - name: Check Test Results
        run: |
          FAILURES=$(grep -r "failures=\"" target/surefire-reports/*.xml | grep -v "failures=\"0\"" | wc -l)
          ERRORS=$(grep -r "errors=\"" target/surefire-reports/*.xml | grep -v "errors=\"0\"" | wc -l)
          
          if [ $FAILURES -gt 0 ] || [ $ERRORS -gt 0 ]; then
            echo "❌ CRITICAL: Integration test failures detected!"
            exit 1
          fi
          
          echo "✅ All integration tests passed!"

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: target/surefire-reports/

  # ============================================================================
  # JOB 6: Full Build Verification
  # ============================================================================
  full-build:
    name: ✅ Full Build Verification
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Full Maven Build
        run: |
          mvn clean verify
          if [ $? -ne 0 ]; then
            echo "❌ CRITICAL: Full build failed!"
            exit 1
          fi
          echo "✅ Full build successful!"

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if test reports directory exists
          if [ ! -d "target/surefire-reports" ]; then
            echo "⚠️ **WARNING:** No test reports directory found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Initialize with defaults to handle empty values
          TOTAL=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null -exec grep -h "tests=" {} \; | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          TOTAL=${TOTAL:-0}
          
          FAILURES=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null -exec grep -h "failures=" {} \; | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          FAILURES=${FAILURES:-0}
          
          ERRORS=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null -exec grep -h "errors=" {} \; | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          ERRORS=${ERRORS:-0}
          
          SKIPPED=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null -exec grep -h "skipped=" {} \; | sed 's/.*skipped="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          SKIPPED=${SKIPPED:-0}
          
          # Avoid division by zero
          if [ "$TOTAL" -eq 0 ]; then
            PASSED=0
            PASS_RATE=0
          else
            PASSED=$((TOTAL - FAILURES - ERRORS - SKIPPED))
            if [ "$PASSED" -lt 0 ]; then
              PASSED=0
            fi
            PASS_RATE=$((PASSED * 100 / TOTAL))
          fi
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ✅ $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ❌ $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ❌ $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ⏭️ $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "| **Pass Rate** | **${PASS_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL" -eq 0 ]; then
            echo "⚠️ **WARNING:** No test results found" >> $GITHUB_STEP_SUMMARY
            exit 0
          elif [ "$FAILURES" -g 0 ]; then
            echo "❌ **FAILED:** Test pass rate below 100%" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **SUCCESS:** Test pass rate achieved" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

  # ============================================================================
  # FINAL STATUS CHECK
  # ============================================================================
  ci-success:
    name: ✅ CI SUCCESS
    runs-on: ubuntu-latest
    needs: [full-build]
    steps:
      - name: Success Notification
        run: |
          echo "════════════════════════════════════════════════════════"
          echo "✅ ALL CI CHECKS PASSED"
          echo "════════════════════════════════════════════════════════"
          echo ""
          echo "✅ Java 17 Enforcement: PASS"
          echo "✅ Code Formatting: PASS"
          echo "✅ Compilation: PASS"
          echo "✅ Unit Tests: PASS (100%)"
          echo "✅ Integration Tests: PASS (100%)"
          echo "✅ Full Build: PASS"
          echo ""
          echo "System is production-ready for financial-grade deployment."
          echo "════════════════════════════════════════════════════════"

